# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Spajzka is a shopping list management application built as a monorepo with three main workspaces:

- **apps/api** - Express.js REST API with TSOA (TypeScript OpenAPI) for automatic route generation and Swagger documentation
- **apps/web** - React SPA (Create React App with CRACO) with Progressive Web App capabilities
- **apps/db** - MongoDB sample data for seeding

**All development and production deployments use Docker Compose exclusively.**

## Development Commands

### Docker (Required)

See [DOCKER.md](./DOCKER.md) for detailed documentation.

```bash
# Production mode - start all services
docker-compose up -d

# Development mode - with hot reload
docker-compose -f docker-compose.dev.yml up -d

# View logs
docker-compose logs -f

# Stop services
docker-compose down
```

### Available Services

When running with Docker Compose:

- **Web App**: http://localhost:3000
- **API**: http://localhost:3010
- **Swagger Docs**: http://localhost:3010/docs
- **MongoDB**: localhost:27017

### Code Formatting

```bash
# Format code (only non-Docker command available)
npm run format
```

### API Build & Start (Inside Docker)

The API container uses these scripts (defined in [apps/api/package.json](apps/api/package.json)):

```bash
# Build (generates TSOA routes/specs then compiles TypeScript)
npm run build

# Start production server
npm run start
```

**Important**: The API uses TSOA for automatic route generation from TypeScript decorators. Routes are auto-generated in `src/routes/` and should NOT be manually edited. Controllers in `src/controllers/` define the API endpoints.

### Web Build (Inside Docker)

The web container uses these scripts (defined in [apps/web/package.json](apps/web/package.json)):

```bash
# Build production bundle (includes version stamping)
npm run build
```

### Database Setup

MongoDB connection details (development):
- **Port**: 27017
- **Username**: `spajzkaadmin`
- **Password**: `spajzkaadmin`
- **Database**: `spajzka`
- **Sample data**: Located in [apps/db/sample/](apps/db/sample/) directory and automatically loaded on first run

## Architecture

### Monorepo Structure

The project is organized as a monorepo with shared packages:

- `packages/tsconfig` - Shared TypeScript configurations
- `packages/eslint-config-custom` - Shared ESLint configuration

### API Architecture

**Framework**: Express.js with TypeScript

**Key Libraries**:
- **TSOA** - Generates Express routes from TypeScript decorators and OpenAPI spec
- **Mongoose** - MongoDB ODM
- **JWT** - Authentication via jsonwebtoken
- **Helmet** - Security headers
- **CORS** - Cross-origin resource sharing

**Structure**:
- `src/controllers/` - TSOA controllers with decorators (e.g., `@Route`, `@Get`, `@Post`)
- `src/services/` - Business logic (AuthService, UserService)
- `src/models/` - Mongoose schemas (Users.ts)
- `src/middleware/` - Express middleware including JWT authentication (AuthMiddleware.ts)
- `src/routes/` - Auto-generated by TSOA (DO NOT EDIT MANUALLY)
- `src/config/` - Configuration management with environment variables
- `public/swagger.json` - Auto-generated OpenAPI spec

**TSOA Configuration**: See `tsoa.json` for:
- Base path: `/api/v1`
- Security: JWT bearer tokens
- Controllers path glob: `src/controllers/**/*.ts`
- Authentication module: `src/middleware/AuthMiddleware.ts`

**Authentication**: JWT-based authentication is handled through TSOA's `@Security("jwt")` decorator, which uses the `expressAuthentication` function in AuthMiddleware.ts.

### Web Architecture

**Framework**: React 18 with TypeScript (Create React App + CRACO)

**Key Features**:
- Progressive Web App with service worker (see `src/service-worker.ts`)
- IndexedDB for offline storage (`src/Other/indexDB.ts`)
- React Router for navigation
- Bootstrap/React-Bootstrap for UI
- Auto-reload on service worker updates via message events

**Structure**:
- `src/Views/` - Page components (Navigation, Spajz, BuyList, etc.)
- `src/Components/` - Reusable components (NavbarCustom, FooterCustom, Input, Search, etc.)
- `src/Other/` - Services and utilities (userService, groupService, itemService, indexDB, notificator)
- `src/Api.ts` - Generated TypeScript API client (from swagger-typescript-api)

**Build Process**: The build script runs `appendVersionWithDate.js` to inject version info before building.

**CRACO Configuration**: Uses CRACO to customize CRA webpack config for:
- Top-level await support
- Path/OS polyfills for browser compatibility
- Auto port selection for dev server

### Database

**Database**: MongoDB

**Setup**: Docker Compose configuration in root `docker-compose.yml` and `docker-compose.dev.yml`

**Credentials** (development):
- Username: `spajzkaadmin`
- Password: `spajzkaadmin`
- Port: 27017
- Database: `spajzka`

**Seeding**: Sample data is located in `apps/db/sample/` directory and can be loaded via MongoDB import tools or manually.

## Environment Variables

Environment variables are configured directly in Docker Compose files:

### API (apps/api)

Configured in `docker-compose.yml` and `docker-compose.dev.yml`:
- `PORT` - API server port (default: 3010)
- `MONGO_URI` - MongoDB connection string
- `DATABASE` - Database name
- `JWT_SECRET` - Secret for JWT signing
- `NODE_ENV` - Environment (development/production)

### Web (apps/web)

Build-time argument in Docker Compose:
- `REACT_APP_SpajzkaAPI` - API base URL (e.g., `http://localhost:3010`)

## API Client Generation Workflow

The TypeScript API client is auto-generated during the web container build process:

1. Update controllers in `apps/api/src/controllers/`
2. TSOA auto-regenerates routes and Swagger spec during API build
3. Web build process generates TypeScript client from `apps/api/public/swagger.json`
4. Generated client is located in `apps/web/src/Api.ts`

## Testing & Debugging

- **Swagger UI**: Available at http://localhost:3010/docs when services are running
- **View Logs**: Use `docker-compose logs -f [service]` to view service logs
- **Development Mode**: Use `docker-compose.dev.yml` for hot reload support
- **Debug Port**: API debug port (9229) is exposed in development mode

## Common Gotchas

- **TSOA Routes**: Never manually edit files in `apps/api/src/routes/` - they are auto-generated
- **Docker Required**: All development must be done via Docker Compose - no local npm scripts
- **Rebuild Required**: Changes to Dockerfiles or environment variables require rebuilding: `docker-compose build`
- **Service Dependencies**: API depends on MongoDB, Web depends on API being built first
- **Service Worker**: The web app uses a service worker; changes may require cache clearing or hard refresh
- **Port Conflicts**: Ensure ports 3000, 3010, and 27017 are available before starting services
